// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// PRODUTOR - Dados do produtor rural
// ==========================================
model Produtor {
  id       String  @id @default(uuid())
  nome     String
  cpfCnpj  String  @unique
  email    String?
  telefone String?
  estado   String?
  cidade   String?

  // Dados tribut√°rios
  regime   String // MEI, Simples, Lucro Presumido, Lucro Real
  culturas String // JSON array de culturas (Soja, Milho, etc)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  notas               NotaFiscal[]
  impostos            ImpostoCalculado[]
  rascunhos           RascunhoNota[]
  eventosFiscais      EventoFiscal[]
  notificacoesFiscais NotificacaoFiscal[]
  relatoriosMensais   RelatorioMensal[]
  pendenciasContador  PendenciaContador[]
  pacotesDocumentos   PacoteDocumentos[]
  agendaItens         AgendaItem[]

  @@map("produtores")
}

// ==========================================
// NOTA FISCAL - Upload e dados de notas
// ==========================================
model NotaFiscal {
  id         String @id @default(uuid())
  produtorId String

  // Identifica√ß√£o da nota
  chaveAcesso String  @unique // 44 d√≠gitos - chave de acesso da NF-e
  tipo        String // "entrada" ou "saida"
  numero      String?
  serie       String?

  // Dados fiscais
  cfop             String? // C√≥digo Fiscal de Opera√ß√£o
  naturezaOperacao String? // Ex: "Venda de mercadoria"

  // Destinat√°rio/Remetente
  nomeEmitente    String?
  cpfCnpjEmitente String?
  destino         String? // estado de destino
  exportacao      Boolean @default(false)

  // Valores totais da nota
  valorTotal    Float
  valorProdutos Float? // Subtotal dos produtos
  valorFrete    Float?
  valorSeguro   Float?
  valorDesconto Float?
  valorOutros   Float?

  // Impostos totais
  valorCbs      Float?
  valorIbs      Float?
  valorFunrural Float?
  valorIcms     Float?
  valorIpi      Float?

  // Arquivo
  arquivoUrl  String? // URL do arquivo (foto ou PDF)
  arquivoTipo String? // "foto" ou "pdf"

  // Status
  status      String  @default("pendente") // pendente, validada, erro
  observacoes String?

  dataEmissao DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  produtor  Produtor         @relation(fields: [produtorId], references: [id], onDelete: Cascade)
  itens     ItemNotaFiscal[]
  rascunhos RascunhoNota[]

  @@index([produtorId])
  @@index([tipo])
  @@index([dataEmissao])
  @@index([chaveAcesso])
  @@map("notas_fiscais")
}

// ==========================================
// ITEM NOTA FISCAL - Produtos/servi√ßos da nota
// ==========================================
model ItemNotaFiscal {
  id           String @id @default(uuid())
  notaFiscalId String

  // Identifica√ß√£o do item
  numeroItem    Int
  codigoProduto String?
  descricao     String
  ncm           String? // Nomenclatura Comum do Mercosul
  cfop          String? // CFOP do item

  // Quantidades e valores
  unidade       String? // kg, ton, sc, L, etc
  quantidade    Float
  valorUnitario Float
  valorTotal    Float
  valorDesconto Float?
  valorFrete    Float?

  // Impostos do item
  baseCalculoIcms Float?
  valorIcms       Float?
  aliquotaIcms    Float?

  baseCalculoIpi Float?
  valorIpi       Float?
  aliquotaIpi    Float?

  valorCbs      Float?
  valorIbs      Float?
  valorFunrural Float?

  // Informa√ß√µes adicionais
  informacoes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamento
  notaFiscal NotaFiscal @relation(fields: [notaFiscalId], references: [id], onDelete: Cascade)

  @@index([notaFiscalId])
  @@index([numeroItem])
  @@map("itens_nota_fiscal")
}

// ==========================================
// IMPOSTO CALCULADO - Hist√≥rico de c√°lculos
// ==========================================
model ImpostoCalculado {
  id         String @id @default(uuid())
  produtorId String

  // Per√≠odo
  mesReferencia Int // 1-12
  anoReferencia Int // 2026

  // Valores calculados
  faturamento Float
  custos      Float?
  lucro       Float?

  // Impostos
  cbs            Float
  ibs            Float
  funrural       Float
  outrosImpostos Float?
  totalImpostos  Float

  // Regime usado
  regime String

  // Detalhes
  detalhes String? // JSON com breakdown detalhado

  createdAt DateTime @default(now())

  // Relacionamento
  produtor Produtor @relation(fields: [produtorId], references: [id], onDelete: Cascade)

  @@index([produtorId])
  @@index([anoReferencia, mesReferencia])
  @@map("impostos_calculados")
}

// ==========================================
// FLUXO DE CAIXA - Agregado autom√°tico
// ==========================================
// Ser√° calculado dinamicamente das notas fiscais
// N√£o precisa de tabela separada - view/query agregada

// ==========================================
// SISTEMA DE GERA√á√ÉO DE NOTAS FISCAIS
// ==========================================

// Rascunho de Nota Fiscal
model RascunhoNota {
  id String @id @default(cuid())

  // Relacionamentos
  produtorId String
  produtor   Produtor @relation(fields: [produtorId], references: [id])
  contadorId String?

  // Dados da Nota
  tipo                String // 'entrada' | 'saida'
  cfop                String?
  naturezaOperacao    String?
  nomeDestinatario    String
  cpfCnpjDestinatario String?
  ufDestino           String?
  dataEmissao         DateTime
  valorTotal          Float    @default(0)
  observacoes         String?

  // Controle de Workflow
  status          String @default("draft") // draft, enviado, revisao, aprovado, reprovado, finalizado
  chaveTemporaria String @unique

  // Feedback do Contador
  feedbackContador   String?
  correcoesSugeridas String?
  dadosCorrigidos    String? // JSON com corre√ß√µes

  // Relacionamento com Nota Final
  notaFinalId String?
  notaFinal   NotaFiscal? @relation(fields: [notaFinalId], references: [id])

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  dataEnvio       DateTime?
  dataFeedback    DateTime?
  dataFinalizacao DateTime?

  // Itens do Rascunho
  itens ItemRascunhoNota[]

  @@map("rascunhos_nota")
}

// Item do Rascunho de Nota Fiscal
model ItemRascunhoNota {
  id String @id @default(cuid())

  // Relacionamento com Rascunho
  rascunhoNotaId String
  rascunhoNota   RascunhoNota @relation(fields: [rascunhoNotaId], references: [id], onDelete: Cascade)

  // Dados do Item
  numeroItem    Int
  codigoProduto String?
  descricao     String
  ncm           String?
  cfop          String?
  unidade       String?
  quantidade    Float
  valorUnitario Float
  valorTotal    Float
  valorDesconto Float?
  valorFrete    Float?

  // Impostos do Item
  baseCalculoIcms Float?
  valorIcms       Float?
  aliquotaIcms    Float?
  baseCalculoIpi  Float?
  valorIpi        Float?
  aliquotaIpi     Float?
  valorCbs        Float?
  valorIbs        Float?
  valorFunrural   Float?

  informacoes String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("itens_rascunho_nota")
}

// ==========================================
// SISTEMA DE CALEND√ÅRIO FISCAL
// ==========================================

// Evento Fiscal
model EventoFiscal {
  id         String @id @default(cuid())
  produtorId String

  // Dados do Evento
  nome          String
  descricao     String
  tipo          String // 'mensal' | 'trimestral' | 'semestral' | 'anual' | 'unico'
  diaVencimento Int // Dia do m√™s (1-31)
  mesVencimento Int? // M√™s espec√≠fico para eventos anuais (1-12)

  // Controle
  ativo       Boolean @default(true)
  obrigatorio Boolean @default(false)
  regime      String // JSON array de regimes que se aplicam
  valor       Float?
  observacoes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  produtor     Produtor            @relation(fields: [produtorId], references: [id], onDelete: Cascade)
  notificacoes NotificacaoFiscal[]

  @@index([produtorId])
  @@index([tipo])
  @@index([diaVencimento])
  @@map("eventos_fiscais")
}

// Notifica√ß√£o Fiscal
model NotificacaoFiscal {
  id             String @id @default(cuid())
  produtorId     String
  eventoFiscalId String

  // Dados da Notifica√ß√£o
  dataVencimento   DateTime
  diasAntecedencia Int
  dataNotificacao  DateTime

  // Status e Envio
  enviado   Boolean   @default(false)
  dataEnvio DateTime?
  tipo      String // 'email' | 'whatsapp' | 'sistema'
  mensagem  String

  // Controle de tentativas
  tentativasEnvio Int       @default(0)
  ultimaTentativa DateTime?
  erro            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  produtor     Produtor     @relation(fields: [produtorId], references: [id], onDelete: Cascade)
  eventoFiscal EventoFiscal @relation(fields: [eventoFiscalId], references: [id], onDelete: Cascade)

  @@index([produtorId])
  @@index([dataVencimento])
  @@index([enviado])
  @@map("notificacoes_fiscais")
}

model AgendaItem {
  id          String  @id @default(cuid())
  produtorId  String
  pendenciaId String? @unique

  titulo    String
  descricao String?
  data      DateTime
  status    String   @default("aberto") // aberto | concluido | cancelado
  tipo      String   @default("pendencia-contador") // pra filtrar na UI

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  produtor  Produtor           @relation(fields: [produtorId], references: [id], onDelete: Cascade)
  pendencia PendenciaContador? @relation(fields: [pendenciaId], references: [id], onDelete: Cascade)

  @@index([produtorId])
  @@index([data])
  @@index([status])
  @@map("agenda_itens")
}

// Relat√≥rio Mensal
model RelatorioMensal {
  id         String @id @default(cuid())
  produtorId String

  // Per√≠odo
  mes Int // 1-12
  ano Int // 2026

  // Dados do Relat√≥rio
  dataGeracao  DateTime @default(now())
  linkDownload String
  nomeArquivo  String
  tamanho      Int? // Tamanho em bytes

  // Envio para contador
  contadorEmail String?
  enviado       Boolean   @default(false)
  dataEnvio     DateTime?

  // Configura√ß√£o autom√°tica
  envioAutomatico Boolean @default(false)
  diaEnvio        Int? // Dia do m√™s para envio
  incluirAnexos   String? // JSON array dos anexos

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamento
  produtor Produtor @relation(fields: [produtorId], references: [id], onDelete: Cascade)

  @@unique([produtorId, mes, ano])
  @@index([produtorId])
  @@index([mes, ano])
  @@map("relatorios_mensais")
}

// Pend√™ncia do Contador
model PendenciaContador {
  id         String  @id @default(cuid())
  produtorId String
  contadorId String?

  titulo          String
  descricao       String
  dataLimite      DateTime
  dataCriacao     DateTime  @default(now())
  dataAtendimento DateTime?

  status     String @default("pendente")
  prioridade String

  tiposDocumentos    String
  observacoes        String?
  observacoesProduto String?

  // üî• ADICIONE ISSO AQUI
  motivoCancelamento String?
  motivoRejeicao     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  produtor   Produtor           @relation(fields: [produtorId], references: [id], onDelete: Cascade)
  documentos DocumentoAnexado[]
  pacotes    PacoteDocumentos[]
  AgendaItem AgendaItem?

  @@map("pendencias_contador")
}

// Documento Anexado
model DocumentoAnexado {
  id          String @id @default(cuid())
  pendenciaId String

  // Dados do Documento
  nomeArquivo    String
  tipoDocumento  String // 'folha-pagamento', 'nf-entrada', 'nf-saida', etc
  tamanho        Int // Tamanho em bytes
  caminhoArquivo String
  checksum       String? // Hash do arquivo para verifica√ß√£o

  // Dados Extra√≠dos pela IA
  dadosExtraidos Json? // Dados extra√≠dos pela IA (valores, datas, observa√ß√µes)

  dataUpload DateTime @default(now())

  // Relacionamento
  pendencia PendenciaContador @relation(fields: [pendenciaId], references: [id], onDelete: Cascade)

  @@index([pendenciaId])
  @@index([tipoDocumento])
  @@map("documentos_anexados")
}

// Pacote de Documentos
model PacoteDocumentos {
  id          String @id @default(cuid())
  pendenciaId String
  produtorId  String

  // Dados do Pacote
  nomePacote         String
  nomeArquivoZip     String
  linkDownload       String
  senha              String?
  tamanho            Int // Tamanho em bytes
  quantidadeArquivos Int

  // Controle de Acesso
  dataGeracao    DateTime  @default(now())
  dataExpiracao  DateTime // 7 dias ap√≥s gera√ß√£o
  downloads      Int       @default(0)
  ultimoDownload DateTime?

  // Notifica√ß√£o
  contadorNotificado Boolean   @default(false)
  dataNotificacao    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  pendencia PendenciaContador @relation(fields: [pendenciaId], references: [id], onDelete: Cascade)
  produtor  Produtor          @relation(fields: [produtorId], references: [id], onDelete: Cascade)

  @@index([produtorId])
  @@index([pendenciaId])
  @@index([dataExpiracao])
  @@map("pacotes_documentos")
}
